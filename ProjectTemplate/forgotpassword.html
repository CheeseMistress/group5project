<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cabin&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href=".\resources\pascal-home.png" />
    <title>Pascal - Forgot Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script type="text/javascript">

        function sendEmail() {
            // Insert code to check email against database then if there is a match,
            // send an email to a reset password page that resets the password only for that email address.
        }

        var validEmail = false;
        var attempts = 0;
        var passPrompted = false;
        var phonePrompted = false;

        function forgotPass() {
            let email = document.getElementById("email").value;
            let feedback = document.getElementById("feedback");
            let carryOn = document.getElementById("carryOn");
            

            // set up web method variables
            let webMethod = "ProjectServices.asmx/GetUsers";
            let parameters = "{}";

            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    let responseFromServer = msg.d
                    let emailFound = true;

                    for (let i = 0; i < responseFromServer.length; i++) {
                        if (email == decodeURI(responseFromServer[i].email) && responseFromServer[i].status == '1') {
                            // if active account email is found in db
                            emailFound = true;
                            feedback.innerHTML = "";
                            if (!phonePrompted) {
                                // if phone entry box does not already exist, create it
                                carryOn.innerHTML = "<label for='phone' required>Verify phone number:</label><br><input id='phone' type='tel' style='width: 100%;'></input >"
                                phonePrompted = true;
                            } else {
                                let phone = document.getElementById("phone").value;
                                if (!passPrompted) {
                                    if (phone == decodeURI(responseFromServer[i].phone) && attempts < 4) {
                                        // if phone number matches account, add reset password prompt
                                        feedback.innerHTML = "";
                                        const pass1Label = document.createElement("label");
                                        pass1Label.setAttribute("for", "pass1");
                                        const pass1LabelContent = document.createTextNode("New Password:");
                                        const pass1Input = document.createElement("input");
                                        pass1Input.setAttribute("id", "pass1");
                                        pass1Input.setAttribute("type", "password");
                                        pass1Input.setAttribute("style", "width: 100%");
                                        pass1Input.setAttribute("required", "");
                                        const pass2Label = document.createElement("label");
                                        pass2Label.setAttribute("for", "pass2");
                                        const pass2LabelContent = document.createTextNode("Re-enter Password:");
                                        const pass2Input = document.createElement("input");
                                        pass2Input.setAttribute("id", "pass2");
                                        pass2Input.setAttribute("type", "password");
                                        pass2Input.setAttribute("style", "width: 100%");
                                        pass2Input.setAttribute("required", "");
                                        pass1Label.appendChild(pass1LabelContent);
                                        pass2Label.appendChild(pass2LabelContent);
                                        carryOn.append(pass1Label);
                                        carryOn.append(pass1Input);
                                        carryOn.append(pass2Label);
                                        carryOn.append(pass2Input);
                                        feedback.innerHTML = "";
                                        passPrompted = true;
                                    } else if (phone != decodeURI(responseFromServer[i].phone) && attempts < 4) {
                                        // if phone number is incorrect
                                        feedback.innerHTML = "Invalid phone number.  Try again.";
                                        attempts++;
                                    } else {
                                        // if invalid phone has been entered too many times, deactivate account
                                        feedback.innerHTML = "Maximum attempts reached.<br>Please wait for support to reactivate account.";

                                        document.getElementById("reset").disabled = true;
                                    }
                                } else {
                                    if (pass1.value == pass2.value) {
                                        feedback.innerHTML = "You entered somethin.";
                                    } else {
                                        feedback.innerHTML = "Passwords do not match.";
                                    }
                                }
                            }
                        } else if (email == decodeURI(responseFromServer[i].email) && responseFromServer[i].status == '0') {
                            if (!emailFound) {
                                feedback.innerHTML = "Account not yet active.&nbsp; Try again later."
                            }
                        } else {
                            if (!emailFound) {
                                feedback.innerHTML = "Email does not match an account."
                            }
                        }
                    }
                },
                error: function (e) {
                    alert("This code will only execute if javascript is unable to access webservice.")
                }         
            });
        }

        function resetPass() {

        }
    </script>

</head>

<body>
    <!-- This is the page header.  This one is specific to this page. -->
    <header>
        <div class="row">
            <div class="col-12"><a href="index.html"><img src=".\resources\pascal-home.png" width="30"></a></div>
        </div>

        <div class="row">
            <div class="col-12" style="text-align: center; margin: 2em 0 2em 0; padding: 5vh 0;">
                <img src=".\resources\pascal-logo.png" style="width: 30%;">
            </div>
        </div>
    </header>

    <main>

        <div class="col-03 filler"></div>
        <div class="col-06 box" id="forgot">
            <form onsubmit="forgotPass(); return false">
                <h2 style="margin-bottom: 2vh;">Forgot Password</h2>
                <div id="feedback" style="font-size: smaller; font-style: italic;"></div>
                <label for="email" required>Email:</label>
                <input id="email" type="email" style="width: 100%;" required>
                <div id="carryOn"></div>
                <button id="reset" type="submit" style="margin-top: 40px; width: 100%;">Reset Password</button>
                <div class="col-12" style="text-align: center;"><a href="login.html" style="font-size: 8pt;">Sign In</a></div>
            </form>
        </div>
        <div class="col-03 filler"></div>
    </main>

</body>

</html>
