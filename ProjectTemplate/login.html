<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cabin&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <title>Pascal</title>
    <!--DO NOT FORGET THIS SCRIPT TAG SO YOU CAN USE JQUERY!!!!!-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!--YOUR OWN JAVASCRIPT CAN GO RIGHT HERE-->
    <script type="text/javascript">

        // attempt control variable
        var attempts = 0;

        function Login() {
            // reset valid each time login is called
            let valid = false;

            // get user input from DOM
            let user = document.getElementById("user").value;
            let pass = document.getElementById("pass").value;

            // set up web method variables
            let webMethod = "ProjectServices.asmx/GetUsers";
            let parameters = "{}";

            //jQuery ajax method
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    // set array returned from web method to a local variable representing the array
                    let responseFromServer = msg.d;

                    // looping through the array of users and comparing to it to user input for validation
                    // userid and password are attributes of a user class
                    for (let i = 0; i < responseFromServer.length; i++) {
                        if (user == decodeURI(responseFromServer[i].userid) && pass == decodeURI(responseFromServer[i].password) && responseFromServer[i].status == '1') {
                            let loginMessage = document.getElementById("loginMessage");
                            loginMessage.innerHTML = `<p><em>${responseFromServer[i].firstname}</em>, you have been successfully logged in!</p>`
                            valid = true;
                            // go to dashboard
                            window.location.replace("dashboard-employees.html");
                        }
                        // if user is in database but has not yet been approved
                        else if (user == decodeURI(responseFromServer[i].userid) && pass == decodeURI(responseFromServer[i].password) && responseFromServer[i].status == '0') {
                            let loginMessage = document.getElementById("loginMessage");
                            loginMessage.innerHTML = `<p><em>${decodeURI(responseFromServer[i].firstname)}</em>, your account has not yet been approved. </p>`
                            // set to true even though account is not approved yet
                            valid = true;
                        }
                    }

                    // if userid and password do not match, update p and increment attempts
                    if (valid == false) {
                        attempts++
                        attemptsLeft = 4 - attempts;
                        let loginMessage = document.getElementById("loginMessage");
                        loginMessage.innerHTML = `Login unsuccessful, please try again! <br> Attempts Left: ` + attemptsLeft + ``
                            ;
                    }

                    // if attempts reaches more than 3, disable input/button
                    if (attempts > 3) {
                        document.getElementById("user").disabled = true;
                        document.getElementById("pass").disabled = true;
                        document.getElementById("login").disabled = true;
                        loginMessage.innerHTML = `<p>You exceeded the allowable amount of login requests!</p>`
                    }
                },
                error: function (e) {
                    alert("this code will only execute if javascript is unable to access the webservice");
                }
            });
        }
    </script>
    <!--END OF YOUR OWN JAVASCRIPT-->
    <style>
        

        input {
            margin: 0 0 2vh 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <!--    <!--<button onclick="javascript: TestButtonHandler();">Click here to test connection!</button>
        <header>
            <h1>Pascal Home Page</h1>
        </header> -->
    <!-- This is the page header.  This one is specific to this page. -->
    <header>
        <div class="row">
            <div class="col-12"><a href="index.html"><img src=".\resources\pascal-home.png" width="30"></a></div>
        </div>

        <div class="row">
            <div class="col-12" style="text-align: center; margin: 2em 0 2em 0; padding: 5vh 0;">
                <img src=".\resources\pascal-logo.png" style="width: 30%;">
            </div>
        </div>
    </header>


    <div class="row">
        <div class="col-04 filler"></div>
        <div class="col-04 box">
            <div class="row"><h2 style="margin-bottom: 2vh;">Sign In</h2></div>
            <div class="row"><label>Username</label></div>
            <div class="row"><input id="user" maxlength="7"></div>

            <div class="row"><label>Password</label></div>
            <div class="row"><input id="pass" type="password"></div>

            <div class="row">
                <div class="col-12" style="text-align: center; height: 6vh; font-size:8pt;" id="loginMessage"></div>
                <button id="login" onclick="Login()" style="font-size: 10pt; width: 100%;">Login</button>
                <div class="col-12" style="text-align: center;"><a href="forgotpassword.html" style="font-size: 8pt;">Forgot Password?</a></div>
            </div>

        </div>
        <div class="col-04 filler"></div>
    </div>


</body>
</html>