<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cabin&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href=".\resources\pascal-home.png" />
    <title>Pascal - Login</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script type="text/javascript">

        // attempt control variable
        var attempts = 0;

        function Login(id, pass) {
            // reset valid each time login is called
            let valid = false;

            // set up web method variables
            let webMethod = "ProjectServices.asmx/LogOn";
            var parameters = "{\"id\":\"" + encodeURI(id) + "\",\"pass\":\"" + encodeURI(pass) + "\"}";
            alert(parameters);
            //jQuery ajax method
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    responseFromServer = msg.d;
                    alert(responseFromServer[0].admin);
                    if (responseFromServer) {
                        valid = true;
                        // go to dashboard
                        if (responseFromServer[0].admin == 1 && responseFromServer[0].status == 1) {
                            let loginMessage = document.getElementById("loginMessage");
                            loginMessage.innerHTML = `<p>You have been successfully logged in!</p>`
                            window.location.replace("admin-manageaccounts.html");
                        }
                        else if (responseFromServer[0].status == 1) {
                            let loginMessage = document.getElementById("loginMessage");
                            loginMessage.innerHTML = `<p>You have been successfully logged in!</p>`
                            window.location.replace("dashboard-results.html");
                        }
                        else {
                            alert("Your account has not yet been approved.");
                        }
                    }
                    else {
                        alert("Log On Failed!");
                    }

                    // if userid and password do not match, update p and increment attempts
                    if (valid == false) {
                        attempts++
                        attemptsLeft = 4 - attempts;
                        let loginMessage = document.getElementById("loginMessage");
                        loginMessage.innerHTML = `Login unsuccessful, please try again! <br> Attempts Left: ` + attemptsLeft + ``
                            ;
                    }

                    // if attempts reaches more than 3, disable input/button
                    if (attempts > 3) {
                        document.getElementById("user").disabled = true;
                        document.getElementById("pass").disabled = true;
                        document.getElementById("login").disabled = true;
                        loginMessage.innerHTML = `<p>You exceeded the allowable amount of login requests!</p>`
                    }
                },
                error: function (e) {
                    alert("this code will only execute if javascript is unable to access the webservice");
                }
            });
        }

    </script>

    <style>

        input {
            margin: 0 0 2vh 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- This is the page header.  This one is specific to this page. -->
    <header>
        <div class="row">
            <div class="col-12"><a href="index.html"><img src=".\resources\pascal-home.png" width="30"></a></div>
        </div>

        <div class="row">
            <div class="col-12" style="text-align: center; margin: 2em 0 2em 0; padding: 5vh 0;">
                <img src=".\resources\pascal-logo.png" style="width: 30%;">
            </div>
        </div>
    </header>

    <form onsubmit="Login($('#user').val(), $('#pass').val()); return false;">
        <div class="row">
            <div class="col-04 filler"></div>
            <div class="col-04 box">
                <div class="row"><h2 style="margin-bottom: 2vh;">Sign In</h2></div>
                <div class="row"><label>Username</label></div>
                <div class="row"><input id="user" maxlength="7"></div>

                <div class="row"><label>Password</label></div>
                <div class="row"><input id="pass" type="password"></div>

                <div class="row">
                    <div class="col-12" style="text-align: center; height: 6vh; font-size:8pt;" id="loginMessage"></div>
                    <button id="login" style="font-size: 10pt; width: 100%;">Sign In</button>
                    <div class="col-12" style="text-align: center;"><a href="forgotpassword.html" style="font-size: 8pt;">Forgot Password?</a></div>
                </div>

            </div>
            <div class="col-04 filler"></div>
        </div>
    </form>



</body>
</html>